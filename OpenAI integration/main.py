import os
import logging
from db.database_manager import DatabaseManager
from ai_text_proccesing.ai_text_processor import AiTextProcessor
from article_processor.article_processor import ArticleProcessor

class Application:
    SIMILARITY_THRESHOLD = 0.6
    HOURS_FROM_LAST_FETCH = 100
    OPEN_AI_EMMBEDDING_MODEL = 'text-embedding-3-large'

    def __init__(self, openai_api_key: str, gimini_api_key: str):
        """
        Initializes the Application with necessary components.

        Args:
            api_key (str): API key for accessing OpenAI services.
        """
        logging.basicConfig(level=logging.INFO,
                            format='%(asctime)s - %(levelname)s - %(message)s',
                            filename='application.log',
                            filemode='w')
        self.db_manager = DatabaseManager()
        self.ai_text_processor = AiTextProcessor(openai_api_key, self.OPEN_AI_EMMBEDDING_MODEL)
        self.processor = ArticleProcessor(gimini_api_key, self.SIMILARITY_THRESHOLD)
        logging.info("Application initialized with API keys.")

    def run(self) -> None:
        """
        Main execution function for the application. Fetches articles, processes them and stores summaries.
        """
        articles = self.db_manager.fetch_articles(self.HOURS_FROM_LAST_FETCH)
        # articles = [
        #     {
        #         "category": "Politics",
        #         "data": '''פוליטי ביטחוני מדיני פלילים ומשפט חינוך וחברה בריאות וסביבה תרבות ובידור כלכלה וצרכנות חדשות בעולם פרשנות ודעות תוכניות חדשות 13 פוליטי ביטחוני מדיני פלילים ומשפט חינוך וחברה בריאות וסביבה תרבות ובידור כלכלה וצרכנות חדשות בעולם פרשנות ודעות תוכניות חדשות 13 חוסלו מחבלים שביצעו ירי על מוצב בשומרון; צה"ל תקף בלבנון לוחמים שביצעו מארב חיסלו שני מחבלים שפתחו בירי לעבר מוצב סאלם - והחרימו נשקים שנמצאו ברכבם. חמאס: "קיבלנו את תשובת ישראל להצעתנו להספקת אש - נלמד אותה". אזעקות הופעלו בגליל המערבי. בלילה: צה"ל תקף מטרות חיזבאללה בלבנון. בכירים ישראלים דנו עם המשלחת המצרית על מתווה לעסקת חטופים | עדכונים שוטפים [timeline id="5180" name="חרבות ברזל - יום 204"] בהכנת הידיעה השתתפו אור הלר, אלון בן דוד, חזי סימנטוב, אלמוג בוקר, מוריה אסרף וולברג, ספי עובדיה, ליאור קינן, אלי סניור, יוסי אלי, ישי פורת, גיל תמרי, נריה קראוס, יוסף ישראל, עלי מוגרבי, נעם ברקן, הילה אלרואי, מאיר מרציאנו, שלומי אלדר, ברוך קרא, אביעד גליקמן, מתן חודורוב, נגה ניר נאמן, חן זנדר, ליאור ורוצלבסקי, מיה איידן, אריאלה שטרנבך, סיון אלקלק, טליה כהן, לירון שמם, נעם גולדברג, טל שורר, רוני שצ'וצ'ינסקי, אלעד זיני, לירן אהרוני, אורי שאבי, רן מאיר ודני מולכו בהכנת הידיעה השתתפו אור הלר, אלון בן דוד, חזי סימנטוב, אלמוג בוקר, מוריה אסרף וולברג, ספי עובדיה, ליאור קינן, אלי סניור, יוסי אלי, ישי פורת, גיל תמרי, נריה קראוס, יוסף ישראל, עלי מוגרבי, נעם ברקן, הילה אלרואי, מאיר מרציאנו, שלומי אלדר, ברוך קרא, אביעד גליקמן, מתן חודורוב, נגה ניר נאמן, חן זנדר, ליאור ורוצלבסקי, מיה איידן, אריאלה שטרנבך, סיון אלקלק, טליה כהן, לירון שמם, נעם גולדברג, טל שורר, רוני שצ'וצ'ינסקי, אלעד זיני, לירן אהרוני, אורי שאבי, רן מאיר ודני מולכו''',
        #         "id": 1,
        #         "link": "https://example.com/article1",
        #         "publish_date": "2024-04-25 10:00:00",
        #         "source": "N13",
        #         "title": '''חוסלו מחבלים שביצעו ירי על מוצב בשומרון; צה"ל תקף בלבנון'''
        #     },
        #     {
        #         "category": "Politics",
        #         "data": '''"מחבל בכיר" חוסל בלבנון, חיזבאללה שיגר 30 רקטות לחרמון והר דב | תיעוד היירוטים ההתחממות בצפון נמשכת, אחרי התקרית בלילה הקודם שבה נהרג מירי נ"ט נהג משאית ישראלי: צה"ל חיסל אמש "מחבל בכיר" בארגון איסלאמיסטי בלבנון, חיזבאללה הגיב עם מטח כבד - ללא נפגעים או נזק. דיווח: גם 2 פעילי חיזבאללה חוסלו אמש ההתחממות בגבול הצפון נמשכת: כ-30 רקטות שוגרו אמש (יום ו') מלבנון בשלושה מטחים, לשטחי ישראל - בעיקר לעבר מוצבי צה"ל בחרמון ובהר דב. לא היו נפגעים ולא נגרם נזק. חיזבאללה קיבל אחריות על המטחים, ואמר שמדובר שבנקמה על תקיפות ישראליות בדרום לבנון ועל חיסול מהאוויר שצה"ל ביצע מוקדם יותר אתמול באזור אל-בקאע בדרום לבנון, במתקפה שבה נהרגו שני פעילים מארגון הטרור האיסלאמיסטי " ג'מאעה איסלאמיה " (הקבוצה האיסלאמית) - שמעורב בלחימה נגד ישראל בצפון וצה"ל כבר תקף כמה פעמים בעבר את פעיליו. החיסול באל-בקאע התרחש בכביש באזור העיירה מידון, כ-21 ק"מ ממטולה. לפי הדיווחים בלבנון התקיפה בוצעה באמצעות כטב"ם. בצה"ל אישרו את הדיווחים, ומסרו כי כלי טיס של חיל האוויר תקף וחיסל את המחבל מסעב חלף, בכיר ב"ג'מאעה איסלאמיה" בלבנון, ונמסר כי הוא קידם פעולות טרור רבות נגד ישראל. "חלף הוביל וקידם פיגועים ומתווי טרור רבים מאדמת לבנון נגד ישראל בגזרה הצפונית במרחב הר דב ובמרחבים נוספים בתקופה האחרונה", נמסר, "חלף פעל בשיתוף פעולה עם שלוחת חמאס בלבנון, תוך תיאום וביצוע פעולות טרור נגד ישראל. סיכולו בוצע בכדי לפגוע ביכולות הארגון לקדם ולבצע פעולות טרור שתכנן בתקופה האחרונה נגד מדינת ישראל בגבול הצפון". ארגון הטרור "ג'מאעה איסלאמיה", והזרוע הצבאית שלו "כוחות פג'ר", הכריזו בהמשך על מותם של חלף ושל פעיל נוסף בשם בלאל מוחמד חלף. לפי הודעת הארגון, השניים נהרגו "במהלך קיום חובתם הג'יהאדיסטית, במסגרת ההגנה על משפחותיהם בדרום ובתמיכה בעם הפלסטיני". זמן לא רק אחרי הודעת צה"ל על חיסול המחבל הבכיר, הרשת הסעודית "אל-ערביה" דיווחה כי שני פעילי חיזבאללה נהרגו בתקיפה בכפר כילא שבדרום לבנון. חיזבאללה לא אישר את הדיווח, אבל בהמשך הודיע על הרג פעיל נוסף שלו. מתחילת המלחמה דיווח ארגון הטרור הלבנוני על 288 הרוגים בשורותיו, אך בישראל מעריכים שהמספר האמיתי גדול יותר. חילופי האש האחרונים מגיעים אחרי התקרית הקשה בלילה שבין חמישי לשישי, שבה נהרג מירי נ"ט של חיזבאללה באזור הר דב נהג המשאית שריף סואעד , תושב הכפר ראס אל-עין שליד כרמיאל. סואעד, ההרוג ה-19 בגבול הצפון מפתיחת המלחמה, שימש כנהג משאית עבור צה"ל במסגרת עבודות תשתית להקמת מכשול שעדיין לא קיים בהר דב. העבודות מתבצעות בעיקר בלילה, בחשכה ולרוב ללא אורות, כדי לא להילכד בתצפיות חיזבאללה - אבל המשאית שבה נהג סואעד נחשפה במהלך נסיעתה. שריף שנהרג סיים רק לפני חצי שנה לבנות את ביתו בראס אל-עין, שם גם ייקבר. במהלך שירותו הצבאי הוא שירת כנהג תובלה. לפניו נהרגו בלחימה בצפון שישה אזרחים, עובד זר ו-11 חיילי צה"ל - האחרון שבהם הוא רס"ן (מיל') דור זימל, סגן מפקד פלוגה מחטיבת עציוני, שמת מפצעיו כמה ימים לאחר שנפצע קשה מתקיפת כטב"ם בשבוע שעבר. על רקע ההתחממות בגזרה הצפונית, ועוד לפני הירי הקטלני של חיזבאללה, נודע ל-ynet כי שלשום נפגש שר הביטחון יואב גלנט עם שליחו המיוחד של הנשיא ביידן ללבנון, עמוס הוכשטיין . הוכשטיין נמצא בישראל לחופשה משפחתית לרגל החג, אך התפנה לשיחות בנוגע להסדר שאותו הוא מקדם בין ישראל ללבנון. במקביל הוכשטיין אמור לשוחח מחר עם נשיא המדינה יצחק הרצוג. בכתבה זו שולבו סרטונים ותמונות מהרשתות החברתיות בשימוש לפי סעיף 27א לחוק זכויות יוצרים. אם ידוע לכם מי צילם אותם - שלחו לנו ב מייל אדום .''',
        #         "id": 2,
        #         "link": "https://example.com/article2",
        #         "publish_date": "2024-04-26 11:00:00",
        #         "source": "Ynet",
        #         "title": '''"מחבל בכיר" חוסל בלבנון, חיזבאללה שיגר 30 רקטות לחרמון והר דב | תיעוד היירוטים'''
        #     },
        #     ]
        similarity_matrix = self.ai_text_processor.get_similarity_matrix(articles)
        article_summaries = self.processor.process_articles(articles, similarity_matrix)
        self.db_manager.insert_summarized_articles(article_summaries)
        self.db_manager.close_connection()

if __name__ == "__main__":
    openai_api_key = os.getenv("OPEN_AI_API_KEY")
    gimini_api_key = os.getenv("GIMINI_API_KEY")
    app = Application(openai_api_key, gimini_api_key)
    app.run()
